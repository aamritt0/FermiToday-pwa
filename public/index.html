<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  
  <!-- Primary Meta Tags -->
  <title>FermiToday - Variazioni Orario</title>
  <meta name="title" content="FermiToday - Variazioni Orario">
  <meta name="description" content="Visualizza le variazioni dell'orario giornaliero in tempo reale">
  
  <!-- Theme Color (Dynamic) -->
  <meta name="theme-color" content="#6366f1">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000000">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#6366f1">
  
  <!-- iOS Specific Meta Tags (CRITICAL for PWA and push notifications) -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="FermiToday">
  
  <!-- iOS Touch Icons -->
  <link rel="apple-touch-icon" href="/icons/logo192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/logo192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/logo192.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/icons/logo192.png">
  
  <!-- Standard Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/logo192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/icons/logo512.png">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  
  <!-- Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- Microsoft Tiles -->
  <meta name="msapplication-TileColor" content="#6366f1">
  <meta name="msapplication-TileImage" content="/icons/logo192.png">
  
  <!-- Preconnect -->
  <link rel="preconnect" href="https://purring-celesta-fermitoday-f00679ea.koyeb.app">
  <link rel="dns-prefetch" href="https://purring-celesta-fermitoday-f00679ea.koyeb.app">
  
  <!-- iOS Safe Area & Optimizations -->
  <style>
    :root {
      --safe-area-inset-top: env(safe-area-inset-top);
      --safe-area-inset-right: env(safe-area-inset-right);
      --safe-area-inset-bottom: env(safe-area-inset-bottom);
      --safe-area-inset-left: env(safe-area-inset-left);
    }
    
    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }
    
    body {
      margin: 0;
      padding: 0;
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
      -webkit-user-select: none;
      user-select: none;
    }
    
    /* Prevent pull-to-refresh on iOS */
    html, body {
      height: 100%;
      overflow: hidden;
    }
    
    #root {
      height: 100%;
      overflow: auto;
      overscroll-behavior-y: contain;
    }
    
    /* Loading state */
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    #loading.hidden {
      display: none;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(99, 102, 241, 0.3);
      border-top-color: #6366f1;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading">
    <div class="spinner"></div>
  </div>
  
  <!-- App Root -->
  <div id="root"></div>
  
  <!-- Service Worker Registration -->
  <script>
    // Hide loading screen when app loads
    window.addEventListener('load', () => {
      setTimeout(() => {
        document.getElementById('loading').classList.add('hidden');
      }, 500);
    });
    
    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(registration => {
            console.log('✅ ServiceWorker registered:', registration.scope);
            
            // Check for updates periodically
            setInterval(() => {
              registration.update();
            }, 60000); // Every minute
            
            // Listen for updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  console.log('🔄 New version available');
                  
                  // Auto-update after 2 seconds
                  setTimeout(() => {
                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                    window.location.reload();
                  }, 2000);
                }
              });
            });
          })
          .catch(error => {
            console.error('❌ ServiceWorker registration failed:', error);
          });
      });
      
      // Handle controller change
      let refreshing = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (!refreshing) {
          refreshing = true;
          window.location.reload();
        }
      });
    }
    
    // Detect iOS and PWA mode
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                  window.navigator.standalone === true;
    
    // Check iOS version for push notification support
    const iOSVersion = (() => {
      const match = navigator.userAgent.match(/OS (\d+)_(\d+)_?(\d+)?/);
      if (match) {
        return parseFloat(`${match[1]}.${match[2]}`);
      }
      return 0;
    })();
    
    const supportsPushNotifications = !isIOS || (isIOS && iOSVersion >= 16.4 && isPWA);
    
    // Log environment info
    console.log('📱 Device Info:', {
      isIOS,
      isPWA,
      iOSVersion: iOSVersion || 'Not iOS',
      supportsPushNotifications,
      standalone: window.matchMedia('(display-mode: standalone)').matches,
      serviceWorker: 'serviceWorker' in navigator,
      pushManager: 'PushManager' in window,
      notification: 'Notification' in window,
      userAgent: navigator.userAgent.substring(0, 50) + '...'
    });
    
    // Store in global for app access
    window.deviceInfo = { 
      isIOS, 
      isPWA, 
      iOSVersion,
      supportsPushNotifications 
    };
    
    // Warn if push notifications won't work
    if (isIOS && (!isPWA || iOSVersion < 16.4)) {
      console.warn('⚠️ Push notifications require iOS 16.4+ and PWA mode (Add to Home Screen)');
    }
  </script>
  
  <!-- Your app bundle (Vite/React) -->
  <script type="module" src="/src/main.jsx"></script>
</body>
</html>